<html lang="zh-TW">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>è¡€å£“ç´€éŒ„è¿½è¹¤å™¨ - é›²ç«¯ç‰ˆ</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            
            body {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                padding: 20px;
            }
            
            .container {
                max-width: 1200px;
                margin: 0 auto;
            }
            
            .auth-container {
                max-width: 450px;
                margin: 100px auto;
                background: white;
                padding: 40px;
                border-radius: 15px;
                box-shadow: 0 10px 50px rgba(0,0,0,0.3);
            }
            h1 {
                text-align: center;
                color: white;
                margin-bottom: 30px;
                
                font-size: 2.5em;
                <!DOCTYPE html>
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .auth-container h2 {
            color: #667eea;
            margin-bottom: 30px;
            text-align: center;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        input[type="date"],
        input[type="time"],
        input[type="number"],
        input[type="text"],
        input[type="email"],
        input[type="password"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: #6b7280;
            margin-top: 10px;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .records-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .records-table th,
        .records-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .records-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
        }

        .records-table tr:hover {
            background: #f5f5f5;
        }

        .status-indicator {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-normal {
            background: #4ade80;
            color: white;
        }

        .status-elevated {
            background: #fbbf24;
            color: white;
        }

        .status-high {
            background: #f87171;
            color: white;
        }

        .delete-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .delete-btn:hover {
            background: #dc2626;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .chart-container {
            height: 300px;
            margin-top: 20px;
            position: relative;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.3);
            position: relative;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 20px;
        }

        .close:hover {
            color: #000;
        }

        .person-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .person-info {
            flex: 1;
        }

        .person-name {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .person-birthdate {
            color: #666;
            font-size: 0.9em;
        }

        .person-age {
            color: #667eea;
            font-weight: 600;
            margin-left: 10px;
        }

        .person-selector {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .person-btn {
            padding: 15px 25px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .person-btn:hover {
            background: #f0f4ff;
        }

        .person-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .current-person-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            text-align: center;
        }

        .current-person-info h3 {
            margin: 0;
            font-size: 1.3em;
        }

        .current-person-info p {
            margin: 5px 0 0 0;
            opacity: 0.9;
        }

        .report-preview {
            background: white;
            padding: 40px;
            border: 1px solid #ddd;
            border-radius: 10px;
            margin-top: 20px;
        }

        .report-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 20px;
        }

        .report-header h2 {
            color: #667eea;
            margin-bottom: 10px;
            border: none;
            padding: 0;
        }

        .report-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .report-info div {
            padding: 8px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .report-info strong {
            color: #667eea;
        }

        .report-summary {
            background: #f0f4ff;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .report-summary h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .report-summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .report-summary-item {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 8px;
        }

        .report-summary-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #667eea;
        }

        .report-summary-label {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 14px;
        }

        .report-table th,
        .report-table td {
            padding: 10px;
            text-align: left;
            border: 1px solid #ddd;
        }

        .report-table th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }

        .report-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .report-footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid #ddd;
            text-align: center;
            color: #666;
            font-size: 12px;
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }

            .card:not(.report-preview) {
                display: none;
            }

            .btn {
                display: none;
            }

            .report-preview {
                border: none;
                box-shadow: none;
            }

            .user-info {
                display: none;
            }

            h1 {
                display: none;
            }
        }

        .user-info {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: white;
            font-size: 1.2em;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .auth-toggle {
            text-align: center;
            margin-top: 20px;
            color: #666;
        }

        .auth-toggle a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }

        .auth-toggle a:hover {
            text-decoration: underline;
        }

        .error-message {
            background: #fee;
            color: #c00;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #fcc;
        }

        .success-message {
            background: #efe;
            color: #060;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #cfc;
        }

        #app-content {
            display: none;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.8em;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .records-table {
                font-size: 14px;
            }

            .records-table th,
            .records-table td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <!-- è¼‰å…¥ä¸­ç•«é¢ -->
    <div id="loading" class="loading">
        <div class="loading-spinner"></div>
        <p>æ­£åœ¨è¼‰å…¥...</p>
    </div>

    <!-- ç™»å…¥/è¨»å†Šä»‹é¢ -->
    <div id="auth-container" class="auth-container" style="display: none;">
        <h2>ğŸ©º è¡€å£“ç´€éŒ„è¿½è¹¤å™¨</h2>
        
        <div id="auth-error" style="display: none;" class="error-message"></div>
        
        <!-- ç™»å…¥è¡¨å–® -->
        <form id="login-form">
            <div class="form-group">
                <label for="login-email">é›»å­éƒµä»¶</label>
                <input type="email" id="login-email" required placeholder="your@email.com">
            </div>
            <div class="form-group">
                <label for="login-password">å¯†ç¢¼</label>
                <input type="password" id="login-password" required placeholder="è‡³å°‘ 6 å€‹å­—å…ƒ">
            </div>
            <button type="submit" class="btn">ğŸ” ç™»å…¥</button>
        </form>

        <div class="auth-toggle">
            é‚„æ²’æœ‰å¸³è™Ÿï¼Ÿ<a href="#" id="show-register">ç«‹å³è¨»å†Š</a>
        </div>

        <!-- è¨»å†Šè¡¨å–® -->
        <form id="register-form" style="display: none;">
            <div class="form-group">
                <label for="register-email">é›»å­éƒµä»¶</label>
                <input type="email" id="register-email" required placeholder="your@email.com">
            </div>
            <div class="form-group">
                <label for="register-password">å¯†ç¢¼</label>
                <input type="password" id="register-password" required placeholder="è‡³å°‘ 6 å€‹å­—å…ƒ">
            </div>
            <div class="form-group">
                <label for="register-password-confirm">ç¢ºèªå¯†ç¢¼</label>
                <input type="password" id="register-password-confirm" required placeholder="å†æ¬¡è¼¸å…¥å¯†ç¢¼">
            </div>
            <button type="submit" class="btn">âœ… è¨»å†Š</button>
        </form>

        <div class="auth-toggle" id="show-login-link" style="display: none;">
            å·²æœ‰å¸³è™Ÿï¼Ÿ<a href="#" id="show-login">è¿”å›ç™»å…¥</a>
        </div>
    </div>

    <!-- ä¸»æ‡‰ç”¨ç¨‹å¼ä»‹é¢ -->
    <div id="app-content">
        <div class="container">
            <h1>ğŸ©º è¡€å£“ç´€éŒ„è¿½è¹¤å™¨</h1>

            <!-- ç”¨æˆ¶è³‡è¨Š -->
            <div class="user-info">
                <div>
                    <strong>ğŸ‘¤ ç™»å…¥å¸³è™Ÿï¼š</strong>
                    <span id="user-email"></span>
                </div>
                <button class="btn btn-danger" onclick="logout()" style="width: auto; padding: 10px 20px;">ğŸšª ç™»å‡º</button>
            </div>

            <!-- äººå“¡ç®¡ç† -->
            <div class="card">
                <h2>ğŸ‘¤ äººå“¡ç®¡ç†</h2>
                <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button class="btn" style="flex: 0 0 auto; width: auto; padding: 10px 20px;" onclick="showAddPersonModal()">â• æ–°å¢äººå“¡</button>
                    <button class="btn" style="flex: 0 0 auto; width: auto; padding: 10px 20px; background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);" onclick="showManagePeopleModal()">âœï¸ ç®¡ç†äººå“¡</button>
                </div>
                <div id="peopleSelector"></div>
            </div>

            <!-- è¼¸å…¥è¡¨å–® -->
            <div class="card">
                <h2>æ–°å¢è¡€å£“ç´€éŒ„</h2>
                <p style="color: #666; margin-bottom: 15px;">ğŸ’¡ æ‚¨å¯ä»¥æ‰‹å‹•è¼¸å…¥ä»»ä½•æ—¥æœŸå’Œæ™‚é–“çš„è¡€å£“è¨˜éŒ„ï¼Œæ”¯æ´æ¯å¤©å¤šæ¬¡é‡åº¦</p>
                <form id="bpForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="date">æ—¥æœŸ *</label>
                            <input type="date" id="date" required>
                        </div>
                        <div class="form-group">
                            <label for="time">æ™‚é–“ *</label>
                            <input type="time" id="time" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="systolic">æ”¶ç¸®å£“ (SYS) mmHg *</label>
                            <input type="number" id="systolic" min="50" max="250" placeholder="ä¾‹å¦‚: 151" required>
                        </div>
                        <div class="form-group">
                            <label for="diastolic">èˆ’å¼µå£“ (DIA) mmHg *</label>
                            <input type="number" id="diastolic" min="30" max="150" placeholder="ä¾‹å¦‚: 75" required>
                        </div>
                        <div class="form-group">
                            <label for="pulse">è„ˆæ (PUL) /åˆ†é˜ *</label>
                            <input type="number" id="pulse" min="40" max="200" placeholder="ä¾‹å¦‚: 74" required>
                        </div>
                    </div>
                    <button type="submit" class="btn">ğŸ’¾ å„²å­˜ç´€éŒ„</button>
                </form>
            </div>

            <!-- çµ±è¨ˆæ•¸æ“š -->
            <div class="card">
                <h2>çµ±è¨ˆæ•¸æ“š</h2>
                <div class="stats-grid" id="statsGrid">
                    <div class="stat-card">
                        <div class="stat-label">å¹³å‡æ”¶ç¸®å£“</div>
                        <div class="stat-value" id="avgSystolic">--</div>
                        <div class="stat-label">mmHg</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">å¹³å‡èˆ’å¼µå£“</div>
                        <div class="stat-value" id="avgDiastolic">--</div>
                        <div class="stat-label">mmHg</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">å¹³å‡è„ˆæ</div>
                        <div class="stat-value" id="avgPulse">--</div>
                        <div class="stat-label">/åˆ†é˜</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ç¸½ç´€éŒ„æ•¸</div>
                        <div class="stat-value" id="totalRecords">0</div>
                        <div class="stat-label">ç­†</div>
                    </div>
                </div>
            </div>

            <!-- å ±è¡¨ç”Ÿæˆ -->
            <div class="card">
                <h2>ğŸ“„ ç”Ÿæˆé†«ç™‚å ±è¡¨</h2>
                <p style="color: #666; margin-bottom: 15px;">ğŸ’¡ é¸æ“‡æ—¥æœŸç¯„åœï¼Œç”Ÿæˆé©åˆçµ¦é†«ç”Ÿåƒè€ƒçš„è¡€å£“è¨˜éŒ„å ±è¡¨</p>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="reportStartDate">é–‹å§‹æ—¥æœŸ</label>
                        <input type="date" id="reportStartDate">
                    </div>
                    <div class="form-group">
                        <label for="reportEndDate">çµæŸæ—¥æœŸ</label>
                        <input type="date" id="reportEndDate">
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn" onclick="generateReport()" style="flex: 1; min-width: 200px;">
                        ğŸ“Š é è¦½å ±è¡¨
                    </button>
                    <button class="btn" onclick="printReport()" style="flex: 1; min-width: 200px; background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                        ğŸ–¨ï¸ åˆ—å°å ±è¡¨
                    </button>
                    <button class="btn" onclick="exportToPDF()" style="flex: 1; min-width: 200px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                        ğŸ“¥ ä¸‹è¼‰ PDF
                    </button>
                </div>

                <div id="reportPreview" style="margin-top: 20px;"></div>
            </div>

            <!-- è¶¨å‹¢åœ–è¡¨ -->
            <div class="card">
                <h2>è¡€å£“è¶¨å‹¢åœ–ï¼ˆæ¯æ—¥å¹³å‡å€¼ï¼‰</h2>
                <p style="color: #666; margin-bottom: 10px;">ğŸ“Š ç•¶å¤©æœ‰å¤šç­†è¨˜éŒ„æ™‚ï¼Œå°‡è‡ªå‹•è¨ˆç®—å¹³å‡å€¼é¡¯ç¤ºåœ¨åœ–è¡¨ä¸­</p>
                <div class="chart-container">
                    <canvas id="bpChart"></canvas>
                </div>
            </div>

            <!-- ç´€éŒ„åˆ—è¡¨ -->
            <div class="card">
                <h2>æ­·å²ç´€éŒ„ï¼ˆè©³ç´°è¨˜éŒ„ï¼‰</h2>
                <p style="color: #666; margin-bottom: 10px;">ğŸ“ é¡¯ç¤ºæ‰€æœ‰é‡åº¦è¨˜éŒ„ï¼ŒåŒ…æ‹¬åŒä¸€å¤©çš„å¤šæ¬¡æ¸¬é‡</p>
                <div id="recordsContainer"></div>
            </div>
        </div>
    </div>

    <!-- æ–°å¢äººå“¡å½ˆå‡ºè¦–çª— -->
    <div id="addPersonModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAddPersonModal()">&times;</span>
            <h2>â• æ–°å¢äººå“¡</h2>
            <form id="addPersonForm">
                <div class="form-group">
                    <label for="personName">å§“å *</label>
                    <input type="text" id="personName" required placeholder="è«‹è¼¸å…¥å§“å">
                </div>
                <div class="form-group">
                    <label for="personBirthdate">å‡ºç”Ÿæ—¥æœŸ *</label>
                    <input type="date" id="personBirthdate" required>
                </div>
                <button type="submit" class="btn">âœ… ç¢ºå®šæ–°å¢</button>
            </form>
        </div>
    </div>

    <!-- ç®¡ç†äººå“¡å½ˆå‡ºè¦–çª— -->
    <div id="managePeopleModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeManagePeopleModal()">&times;</span>
            <h2>âœï¸ ç®¡ç†äººå“¡</h2>
            <div id="peopleList"></div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // ============================================
        // Firebase é…ç½® - è«‹æ›¿æ›ç‚ºæ‚¨çš„é…ç½®è³‡è¨Š
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyADR2izYInbRppU2iG0lfRqJSBbB0eRwdg",
            authDomain: "blood-pressure-tracker-b6d00.firebaseapp.com",
            projectId: "blood-pressure-tracker-b6d00",
             storageBucket: "blood-pressure-tracker-b6d00.firebasestorage.app",
             messagingSenderId: "662293506727",
             appId: "1:662293506727:web:e8aa5980d076ddb5ff0982"
        };

        // åˆå§‹åŒ– Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // å…¨åŸŸè®Šæ•¸
        let currentUser = null;
        let currentPersonId = null;
        let people = [];
        let records = [];
        let chart = null;

        // ============================================
        // èªè­‰ç›¸é—œå‡½æ•¸
        // ============================================

        // ç›£è½èªè­‰ç‹€æ…‹
        auth.onAuthStateChanged(user => {
            document.getElementById('loading').style.display = 'none';
            
            if (user) {
                currentUser = user;
                document.getElementById('auth-container').style.display = 'none';
                document.getElementById('app-content').style.display = 'block';
                document.getElementById('user-email').textContent = user.email;
                
                // è¼‰å…¥ç”¨æˆ¶æ•¸æ“š
                loadUserData();
            } else {
                currentUser = null;
                document.getElementById('auth-container').style.display = 'block';
                document.getElementById('app-content').style.display = 'none';
            }
        });

        // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
        function showAuthError(message) {
            const errorDiv = document.getElementById('auth-error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        // ç™»å…¥è¡¨å–®
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                console.error('ç™»å…¥éŒ¯èª¤:', error);
                showAuthError(getErrorMessage(error.code));
            }
        });

        // è¨»å†Šè¡¨å–®
        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-password-confirm').value;

            if (password !== confirmPassword) {
                showAuthError('å…©æ¬¡è¼¸å…¥çš„å¯†ç¢¼ä¸ä¸€è‡´ï¼');
                return;
            }

            if (password.length < 6) {
                showAuthError('å¯†ç¢¼è‡³å°‘éœ€è¦ 6 å€‹å­—å…ƒï¼');
                return;
            }

            try {
                await auth.createUserWithEmailAndPassword(email, password);
                alert('âœ… è¨»å†ŠæˆåŠŸï¼æ­¡è¿ä½¿ç”¨è¡€å£“ç´€éŒ„è¿½è¹¤å™¨');
            } catch (error) {
                console.error('è¨»å†ŠéŒ¯èª¤:', error);
                showAuthError(getErrorMessage(error.code));
            }
        });

        // åˆ‡æ›ç™»å…¥/è¨»å†Šè¡¨å–®
        document.getElementById('show-register').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('login-form').style.display = 'none';
            document.getElementById('register-form').style.display = 'block';
            document.querySelector('.auth-toggle').style.display = 'none';
            document.getElementById('show-login-link').style.display = 'block';
        });

        document.getElementById('show-login').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('login-form').style.display = 'block';
            document.getElementById('register-form').style.display = 'none';
            document.querySelector('.auth-toggle').style.display = 'block';
            document.getElementById('show-login-link').style.display = 'none';
        });

        // ç™»å‡º
        function logout() {
            if (confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) {
                auth.signOut();
            }
        }

        // éŒ¯èª¤è¨Šæ¯ç¿»è­¯
        function getErrorMessage(errorCode) {
            const messages = {
                'auth/user-not-found': 'æ­¤å¸³è™Ÿä¸å­˜åœ¨',
                'auth/wrong-password': 'å¯†ç¢¼éŒ¯èª¤',
                'auth/email-already-in-use': 'æ­¤é›»å­éƒµä»¶å·²è¢«è¨»å†Š',
                'auth/invalid-email': 'é›»å­éƒµä»¶æ ¼å¼ä¸æ­£ç¢º',
                'auth/weak-password': 'å¯†ç¢¼å¼·åº¦å¤ªå¼±',
                'auth/too-many-requests': 'å˜—è©¦æ¬¡æ•¸éå¤šï¼Œè«‹ç¨å¾Œå†è©¦',
                'auth/network-request-failed': 'ç¶²è·¯é€£ç·šå¤±æ•—'
            };
            return messages[errorCode] || 'ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦';
        }

        // ============================================
        // æ•¸æ“šè¼‰å…¥
        // ============================================

        async function loadUserData() {
            try {
                // è¼‰å…¥äººå“¡è³‡æ–™
                const peopleSnapshot = await db.collection('people')
                    .where('userId', '==', currentUser.uid)
                    .get();
                
                people = peopleSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                // å¦‚æœæœ‰äººå“¡ï¼Œé¸æ“‡ç¬¬ä¸€å€‹
                if (people.length > 0 && !currentPersonId) {
                    currentPersonId = people[0].id;
                }

                displayPeopleSelector();
                
                // è¼‰å…¥è¨˜éŒ„
                if (currentPersonId) {
                    await loadRecords();
                }
            } catch (error) {
                console.error('è¼‰å…¥æ•¸æ“šéŒ¯èª¤:', error);
                alert('è¼‰å…¥æ•¸æ“šæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
            }
        }

        async function loadRecords() {
            try {
                const recordsSnapshot = await db.collection('records')
                    .where('userId', '==', currentUser.uid)
                    .where('personId', '==', currentPersonId)
                    .orderBy('recordDate', 'desc')
                    .orderBy('recordTime', 'desc')
                    .get();
                
                records = recordsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                displayRecords();
                updateStats();
                updateChart();
            } catch (error) {
                console.error('è¼‰å…¥è¨˜éŒ„éŒ¯èª¤:', error);
            }
        }

        // ============================================
        // äººå“¡ç®¡ç†
        // ============================================

        function displayPeopleSelector() {
            const container = document.getElementById('peopleSelector');
            
            if (people.length === 0) {
                container.innerHTML = '<p style="color: #999;">è«‹å…ˆæ–°å¢äººå“¡è³‡æ–™</p>';
                return;
            }

            let html = '<div class="person-selector">';
            
            people.forEach(person => {
                const age = calculateAge(person.birthdate);
                const isActive = person.id === currentPersonId ? 'active' : '';
                html += `
                    <button class="person-btn ${isActive}" onclick="selectPerson('${person.id}')">
                        ğŸ‘¤ ${person.name}<br>
                        <small>(${age}æ­²)</small>
                    </button>
                `;
            });
            
            html += '</div>';
            
            if (currentPersonId) {
                const currentPerson = people.find(p => p.id === currentPersonId);
                if (currentPerson) {
                    const age = calculateAge(currentPerson.birthdate);
                    html = `
                        <div class="current-person-info">
                            <h3>ğŸ‘¤ ${currentPerson.name}</h3>
                            <p>å‡ºç”Ÿæ—¥æœŸ: ${currentPerson.birthdate} (${age}æ­²)</p>
                        </div>
                    ` + html;
                }
            }
            
            container.innerHTML = html;
        }

        async function selectPerson(personId) {
            currentPersonId = personId;
            displayPeopleSelector();
            await loadRecords();
        }

        function calculateAge(birthdate) {
            const today = new Date();
            const birth = new Date(birthdate);
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            
            return age;
        }

        function showAddPersonModal() {
            document.getElementById('addPersonModal').style.display = 'block';
        }

        function closeAddPersonModal() {
            document.getElementById('addPersonModal').style.display = 'none';
        }

        function showManagePeopleModal() {
            document.getElementById('managePeopleModal').style.display = 'block';
            displayPeopleList();
        }

        function closeManagePeopleModal() {
            document.getElementById('managePeopleModal').style.display = 'none';
        }

        async function displayPeopleList() {
            const container = document.getElementById('peopleList');
            
            if (people.length === 0) {
                container.innerHTML = '<p style="color: #999; text-align: center;">ç›®å‰æ²’æœ‰äººå“¡è³‡æ–™</p>';
                return;
            }

            let html = '';
            for (const person of people) {
                const age = calculateAge(person.birthdate);
                
                // è¨ˆç®—è¨˜éŒ„æ•¸
                const recordCount = records.filter(r => r.personId === person.id).length;
                
                html += `
                    <div class="person-card">
                        <div class="person-info">
                            <div class="person-name">ğŸ‘¤ ${person.name}</div>
                            <div class="person-birthdate">
                                å‡ºç”Ÿæ—¥æœŸ: ${person.birthdate} 
                                <span class="person-age">(${age}æ­²)</span>
                            </div>
                            <div style="color: #666; font-size: 0.85em; margin-top: 5px;">
                                ğŸ“Š å…±æœ‰ ${recordCount} ç­†è¨˜éŒ„
                            </div>
                        </div>
                        <button class="delete-btn" onclick="deletePerson('${person.id}', '${person.name}', ${recordCount})">
                            ğŸ—‘ï¸ åˆªé™¤
                        </button>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        document.getElementById('addPersonForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const personData = {
                userId: currentUser.uid,
                name: document.getElementById('personName').value,
                birthdate: document.getElementById('personBirthdate').value,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                const docRef = await db.collection('people').add(personData);
                
                people.push({
                    id: docRef.id,
                    ...personData
                });

                if (people.length === 1) {
                    currentPersonId = docRef.id;
                }

                document.getElementById('addPersonForm').reset();
                closeAddPersonModal();
                displayPeopleSelector();

                alert(`âœ… å·²æˆåŠŸæ–°å¢äººå“¡ï¼š${personData.name}`);
            } catch (error) {
                console.error('æ–°å¢äººå“¡éŒ¯èª¤:', error);
                alert('æ–°å¢äººå“¡æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
        });

        async function deletePerson(personId, personName, recordCount) {
            const message = recordCount > 0 
                ? `ç¢ºå®šè¦åˆªé™¤ ${personName} å—ï¼Ÿ\nâš ï¸ é€™å°‡åŒæ™‚åˆªé™¤è©²äººå“¡çš„ ${recordCount} ç­†è¡€å£“è¨˜éŒ„ï¼`
                : `ç¢ºå®šè¦åˆªé™¤ ${personName} å—ï¼Ÿ`;

            if (confirm(message)) {
                try {
                    // åˆªé™¤äººå“¡
                    await db.collection('people').doc(personId).delete();

                    // åˆªé™¤è©²äººå“¡çš„æ‰€æœ‰è¨˜éŒ„
                    const recordsSnapshot = await db.collection('records')
                        .where('personId', '==', personId)
                        .get();
                    
                    const batch = db.batch();
                    recordsSnapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();

                    // æ›´æ–°æœ¬åœ°æ•¸æ“š
                    people = people.filter(p => p.id !== personId);
                    records = records.filter(r => r.personId !== personId);

                    if (currentPersonId === personId) {
                        currentPersonId = people.length > 0 ? people[0].id : null;
                    }

                    displayPeopleList();
                    displayPeopleSelector();
                    displayRecords();
                    updateStats();
                    updateChart();

                    alert(`âœ… å·²åˆªé™¤ ${personName} åŠå…¶ç›¸é—œè¨˜éŒ„`);
                } catch (error) {
                    console.error('åˆªé™¤äººå“¡éŒ¯èª¤:', error);
                    alert('åˆªé™¤äººå“¡æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
                }
            }
        }

        // ============================================
        // è¡€å£“è¨˜éŒ„
        // ============================================

        // åˆå§‹åŒ–æ—¥æœŸæ™‚é–“
        document.addEventListener('DOMContentLoaded', function() {
            const now = new Date();
            document.getElementById('date').valueAsDate = now;
            document.getElementById('time').value = now.toTimeString().slice(0, 5);
        });

        document.getElementById('bpForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!currentPersonId) {
                alert('âš ï¸ è«‹å…ˆé¸æ“‡æˆ–æ–°å¢äººå“¡ï¼');
                showAddPersonModal();
                return;
            }

            const recordData = {
                userId: currentUser.uid,
                personId: currentPersonId,
                recordDate: document.getElementById('date').value,
                recordTime: document.getElementById('time').value,
                systolic: parseInt(document.getElementById('systolic').value),
                diastolic: parseInt(document.getElementById('diastolic').value),
                pulse: parseInt(document.getElementById('pulse').value),
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                const docRef = await db.collection('records').add(recordData);
                
                records.unshift({
                    id: docRef.id,
                    ...recordData
                });

                // æ¸…ç©ºè¡¨å–®
                document.getElementById('systolic').value = '';
                document.getElementById('diastolic').value = '';
                document.getElementById('pulse').value = '';
                document.getElementById('systolic').focus();

                displayRecords();
                updateStats();
                updateChart();

                const todayCount = records.filter(r => 
                    r.personId === currentPersonId && 
                    r.recordDate === recordData.recordDate
                ).length;
                
                const person = people.find(p => p.id === currentPersonId);
                alert(`âœ… å·²ç‚º ${person.name} å„²å­˜ç´€éŒ„ï¼\nğŸ“… ${recordData.recordDate} å·²æœ‰ ${todayCount} ç­†è¨˜éŒ„`);
            } catch (error) {
                console.error('å„²å­˜è¨˜éŒ„éŒ¯èª¤:', error);
                alert('å„²å­˜è¨˜éŒ„æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
        });

        function getBPStatus(systolic, diastolic) {
            if (systolic < 120 && diastolic < 80) {
                return { text: 'æ­£å¸¸', class: 'status-normal' };
            } else if (systolic < 140 || diastolic < 90) {
                return { text: 'åé«˜', class: 'status-elevated' };
            } else {
                return { text: 'é«˜è¡€å£“', class: 'status-high' };
            }
        }

        function displayRecords() {
            const container = document.getElementById('recordsContainer');

            if (!currentPersonId) {
                container.innerHTML = '<div class="empty-state"><p>è«‹å…ˆé¸æ“‡äººå“¡</p></div>';
                return;
            }

            const personRecords = records.filter(r => r.personId === currentPersonId);

            if (personRecords.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>ç›®å‰æ²’æœ‰ç´€éŒ„ï¼Œè«‹æ–°å¢ç¬¬ä¸€ç­†è¡€å£“æ•¸æ“š</p></div>';
                return;
            }

            let html = `
                <table class="records-table">
                    <thead>
                        <tr>
                            <th>æ—¥æœŸ</th>
                            <th>æ™‚é–“</th>
                            <th>æ”¶ç¸®å£“</th>
                            <th>èˆ’å¼µå£“</th>
                            <th>è„ˆæ</th>
                            <th>ç‹€æ…‹</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            personRecords.forEach(record => {
                const status = getBPStatus(record.systolic, record.diastolic);
                html += `
                    <tr>
                        <td>${record.recordDate}</td>
                        <td>${record.recordTime}</td>
                        <td>${record.systolic} mmHg</td>
                        <td>${record.diastolic} mmHg</td>
                        <td>${record.pulse} /åˆ†</td>
                        <td><span class="status-indicator ${status.class}">${status.text}</span></td>
                        <td><button class="delete-btn" onclick="deleteRecord('${record.id}')">åˆªé™¤</button></td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        async function deleteRecord(recordId) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ')) {
                try {
                    await db.collection('records').doc(recordId).delete();
                    records = records.filter(r => r.id !== recordId);
                    displayRecords();
                    updateStats();
                    updateChart();
                } catch (error) {
                    console.error('åˆªé™¤è¨˜éŒ„éŒ¯èª¤:', error);
                    alert('åˆªé™¤è¨˜éŒ„æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
                }
            }
        }

        function updateStats() {
            if (!currentPersonId) {
                document.getElementById('avgSystolic').textContent = '--';
                document.getElementById('avgDiastolic').textContent = '--';
                document.getElementById('avgPulse').textContent = '--';
                document.getElementById('totalRecords').textContent = '0';
                return;
            }

            const personRecords = records.filter(r => r.personId === currentPersonId);

            if (personRecords.length === 0) {
                document.getElementById('avgSystolic').textContent = '--';
                document.getElementById('avgDiastolic').textContent = '--';
                document.getElementById('avgPulse').textContent = '--';
                document.getElementById('totalRecords').textContent = '0';
                return;
            }

            const avgSys = Math.round(personRecords.reduce((sum, r) => sum + r.systolic, 0) / personRecords.length);
            const avgDia = Math.round(personRecords.reduce((sum, r) => sum + r.diastolic, 0) / personRecords.length);
            const avgPul = Math.round(personRecords.reduce((sum, r) => sum + r.pulse, 0) / personRecords.length);

            document.getElementById('avgSystolic').textContent = avgSys;
            document.getElementById('avgDiastolic').textContent = avgDia;
            document.getElementById('avgPulse').textContent = avgPul;
            document.getElementById('totalRecords').textContent = personRecords.length;
        }

        function updateChart() {
            const ctx = document.getElementById('bpChart').getContext('2d');

            if (chart) {
                chart.destroy();
            }

            if (!currentPersonId) {
                return;
            }

            const personRecords = records.filter(r => r.personId === currentPersonId);

            if (personRecords.length === 0) {
                return;
            }

            // æŒ‰æ—¥æœŸåˆ†çµ„ä¸¦è¨ˆç®—æ¯æ—¥å¹³å‡å€¼
            const dailyAverages = {};
            
            personRecords.forEach(record => {
                const date = record.recordDate;
                
                if (!dailyAverages[date]) {
                    dailyAverages[date] = {
                        systolic: [],
                        diastolic: [],
                        pulse: [],
                        count: 0
                    };
                }
                
                dailyAverages[date].systolic.push(record.systolic);
                dailyAverages[date].diastolic.push(record.diastolic);
                dailyAverages[date].pulse.push(record.pulse);
                dailyAverages[date].count++;
            });

            const dailyData = Object.keys(dailyAverages)
                .map(date => {
                    const data = dailyAverages[date];
                    const avgSys = Math.round(data.systolic.reduce((a, b) => a + b, 0) / data.count);
                    const avgDia = Math.round(data.diastolic.reduce((a, b) => a + b, 0) / data.count);
                    const avgPul = Math.round(data.pulse.reduce((a, b) => a + b, 0) / data.count);
                    
                    return {
                        date: date,
                        systolic: avgSys,
                        diastolic: avgDia,
                        pulse: avgPul,
                        count: data.count
                    };
                })
                .sort((a, b) => new Date(a.date) - new Date(b.date))
                .slice(-30);

            const labels = dailyData.map(d => `${d.date}\n(${d.count}æ¬¡)`);
            const systolicData = dailyData.map(d => d.systolic);
            const diastolicData = dailyData.map(d => d.diastolic);
            const pulseData = dailyData.map(d => d.pulse);

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'æ”¶ç¸®å£“ (SYS) å¹³å‡',
                            data: systolicData,
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'èˆ’å¼µå£“ (DIA) å¹³å‡',
                            data: diastolicData,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'è„ˆæ (PUL) å¹³å‡',
                            data: pulseData,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const index = context.dataIndex;
                                    return `ç•¶æ—¥é‡åº¦æ¬¡æ•¸: ${dailyData[index].count}æ¬¡`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'æ•¸å€¼ (mmHg / bpm)'
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                font: {
                                    size: 10
                                }
                            },
                            title: {
                                display: true,
                                text: 'æ—¥æœŸ (é‡åº¦æ¬¡æ•¸)'
                            }
                        }
                    }
                }
            });
        }

        // é»æ“Šå½ˆå‡ºè¦–çª—å¤–éƒ¨é—œé–‰
        window.onclick = function(event) {
            const addModal = document.getElementById('addPersonModal');
            const manageModal = document.getElementById('managePeopleModal');
            
            if (event.target == addModal) {
                closeAddPersonModal();
            }
            if (event.target == manageModal) {
                closeManagePeopleModal();
            }
        }

        // ============================================
        // å ±è¡¨ç”ŸæˆåŠŸèƒ½
        // ============================================

        // åˆå§‹åŒ–å ±è¡¨æ—¥æœŸï¼ˆé è¨­æœ€è¿‘30å¤©ï¼‰
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date();
            const thirtyDaysAgo = new Date(today);
            thirtyDaysAgo.setDate(today.getDate() - 30);
            
            document.getElementById('reportEndDate').valueAsDate = today;
            document.getElementById('reportStartDate').valueAsDate = thirtyDaysAgo;
        });

        function generateReport() {
            if (!currentPersonId) {
                alert('âš ï¸ è«‹å…ˆé¸æ“‡äººå“¡ï¼');
                return;
            }

            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;

            if (!startDate || !endDate) {
                alert('âš ï¸ è«‹é¸æ“‡é–‹å§‹å’ŒçµæŸæ—¥æœŸï¼');
                return;
            }

            if (new Date(startDate) > new Date(endDate)) {
                alert('âš ï¸ é–‹å§‹æ—¥æœŸä¸èƒ½æ™šæ–¼çµæŸæ—¥æœŸï¼');
                return;
            }

            const person = people.find(p => p.id === currentPersonId);
            const filteredRecords = records.filter(r => 
                r.personId === currentPersonId &&
                r.recordDate >= startDate &&
                r.recordDate <= endDate
            ).sort((a, b) => {
                if (a.recordDate !== b.recordDate) {
                    return new Date(a.recordDate) - new Date(b.recordDate);
                }
                return a.recordTime.localeCompare(b.recordTime);
            });

            if (filteredRecords.length === 0) {
                alert('ğŸ“­ é¸æ“‡çš„æ—¥æœŸç¯„åœå…§æ²’æœ‰è¨˜éŒ„ï¼');
                return;
            }

            // è¨ˆç®—çµ±è¨ˆæ•¸æ“š
            const avgSystolic = Math.round(filteredRecords.reduce((sum, r) => sum + r.systolic, 0) / filteredRecords.length);
            const avgDiastolic = Math.round(filteredRecords.reduce((sum, r) => sum + r.diastolic, 0) / filteredRecords.length);
            const avgPulse = Math.round(filteredRecords.reduce((sum, r) => sum + r.pulse, 0) / filteredRecords.length);
            
            const maxSystolic = Math.max(...filteredRecords.map(r => r.systolic));
            const minSystolic = Math.min(...filteredRecords.map(r => r.systolic));
            const maxDiastolic = Math.max(...filteredRecords.map(r => r.diastolic));
            const minDiastolic = Math.min(...filteredRecords.map(r => r.diastolic));

            // ç”Ÿæˆå ±è¡¨ HTML
            let reportHTML = `
                <div class="report-preview" id="printableReport">
                    <div class="report-header">
                        <h2>ğŸ©º è¡€å£“ç›£æ¸¬å ±å‘Š</h2>
                        <p style="color: #666;">Blood Pressure Monitoring Report</p>
                    </div>

                    <div class="report-info">
                        <div><strong>å§“å Name:</strong> ${person.name}</div>
                        <div><strong>å‡ºç”Ÿæ—¥æœŸ DOB:</strong> ${person.birthdate} (${calculateAge(person.birthdate)}æ­²)</div>
                        <div><strong>å ±å‘Šæ—¥æœŸ Report Date:</strong> ${new Date().toLocaleDateString('zh-TW')}</div>
                        <div><strong>è¨˜éŒ„æœŸé–“ Period:</strong> ${startDate} è‡³ ${endDate}</div>
                    </div>

                    <div class="report-summary">
                        <h3>ğŸ“Š çµ±è¨ˆæ‘˜è¦ Summary</h3>
                        <div class="report-summary-grid">
                            <div class="report-summary-item">
                                <div class="report-summary-value">${filteredRecords.length}</div>
                                <div class="report-summary-label">ç¸½è¨˜éŒ„æ•¸<br>Total Records</div>
                            </div>
                            <div class="report-summary-item">
                                <div class="report-summary-value">${avgSystolic}</div>
                                <div class="report-summary-label">å¹³å‡æ”¶ç¸®å£“<br>Avg Systolic (mmHg)</div>
                            </div>
                            <div class="report-summary-item">
                                <div class="report-summary-value">${avgDiastolic}</div>
                                <div class="report-summary-label">å¹³å‡èˆ’å¼µå£“<br>Avg Diastolic (mmHg)</div>
                            </div>
                            <div class="report-summary-item">
                                <div class="report-summary-value">${avgPulse}</div>
                                <div class="report-summary-label">å¹³å‡è„ˆæ<br>Avg Pulse (bpm)</div>
                            </div>
                            <div class="report-summary-item">
                                <div class="report-summary-value">${maxSystolic}/${maxDiastolic}</div>
                                <div class="report-summary-label">æœ€é«˜è¡€å£“<br>Max BP</div>
                            </div>
                            <div class="report-summary-item">
                                <div class="report-summary-value">${minSystolic}/${minDiastolic}</div>
                                <div class="report-summary-label">æœ€ä½è¡€å£“<br>Min BP</div>
                            </div>
                        </div>
                    </div>

                    <h3 style="color: #667eea; margin-top: 30px; margin-bottom: 15px;">ğŸ“‹ è©³ç´°è¨˜éŒ„ Detailed Records</h3>
                    <table class="report-table">
                        <thead>
                            <tr>
                                <th>æ—¥æœŸ<br>Date</th>
                                <th>æ™‚é–“<br>Time</th>
                                <th>æ”¶ç¸®å£“<br>Systolic (mmHg)</th>
                                <th>èˆ’å¼µå£“<br>Diastolic (mmHg)</th>
                                <th>è„ˆæ<br>Pulse (bpm)</th>
                                <th>ç‹€æ…‹<br>Status</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            filteredRecords.forEach(record => {
                const status = getBPStatus(record.systolic, record.diastolic);
                reportHTML += `
                    <tr>
                        <td>${record.recordDate}</td>
                        <td>${record.recordTime}</td>
                        <td style="text-align: center;">${record.systolic}</td>
                        <td style="text-align: center;">${record.diastolic}</td>
                        <td style="text-align: center;">${record.pulse}</td>
                        <td><span class="status-indicator ${status.class}">${status.text}</span></td>
                    </tr>
                `;
            });

            reportHTML += `
                        </tbody>
                    </table>

                    <div class="report-footer">
                        <p><strong>å‚™è¨» Notes:</strong></p>
                        <p>æ­£å¸¸è¡€å£“ï¼šæ”¶ç¸®å£“ < 120 mmHgï¼Œèˆ’å¼µå£“ < 80 mmHg</p>
                        <p>Normal BP: Systolic < 120 mmHg, Diastolic < 80 mmHg</p>
                        <p style="margin-top: 20px;">æœ¬å ±å‘Šç”±è¡€å£“è¿½è¹¤ç³»çµ±è‡ªå‹•ç”Ÿæˆï¼Œåƒ…ä¾›é†«ç™‚åƒè€ƒ</p>
                        <p>This report is automatically generated for medical reference only</p>
                    </div>
                </div>
            `;

            document.getElementById('reportPreview').innerHTML = reportHTML;

            // æ»¾å‹•åˆ°å ±è¡¨ä½ç½®
            document.getElementById('reportPreview').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function printReport() {
            const reportContent = document.getElementById('printableReport');
            
            if (!reportContent) {
                alert('âš ï¸ è«‹å…ˆé»æ“Šã€Œé è¦½å ±è¡¨ã€ç”Ÿæˆå ±è¡¨ï¼');
                return;
            }

            window.print();
        }

        async function exportToPDF() {
            const reportContent = document.getElementById('printableReport');
            
            if (!reportContent) {
                alert('âš ï¸ è«‹å…ˆé»æ“Šã€Œé è¦½å ±è¡¨ã€ç”Ÿæˆå ±è¡¨ï¼');
                return;
            }

            // ä½¿ç”¨ html2canvas å’Œ jsPDF ç”Ÿæˆ PDF
            // éœ€è¦åŠ è¼‰é€™äº›åº«
            if (typeof html2canvas === 'undefined' || typeof jspdf === 'undefined') {
                alert('ğŸ“¥ æ­£åœ¨è¼‰å…¥ PDF ç”Ÿæˆå·¥å…·ï¼Œè«‹ç¨å€™å†è©¦...');
                
                // å‹•æ…‹è¼‰å…¥åº«
                const script1 = document.createElement('script');
                script1.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
                document.head.appendChild(script1);
                
                const script2 = document.createElement('script');
                script2.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
                document.head.appendChild(script2);
                
                return;
            }

            try {
                // ç”Ÿæˆ PDF
                const canvas = await html2canvas(reportContent, {
                    scale: 2,
                    useCORS: true,
                    logging: false
                });

                const imgData = canvas.toDataURL('image/png');
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                const imgWidth = 210; // A4 å¯¬åº¦
                const pageHeight = 297; // A4 é«˜åº¦
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;

                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                const person = people.find(p => p.id === currentPersonId);
                const startDate = document.getElementById('reportStartDate').value;
                const endDate = document.getElementById('reportEndDate').value;
                const filename = `è¡€å£“å ±å‘Š_${person.name}_${startDate}_${endDate}.pdf`;
                
                pdf.save(filename);
                
                alert('âœ… PDF å·²æˆåŠŸä¸‹è¼‰ï¼');
            } catch (error) {
                console.error('PDF ç”ŸæˆéŒ¯èª¤:', error);
                alert('âŒ PDF ç”Ÿæˆå¤±æ•—ï¼Œè«‹å˜—è©¦ä½¿ç”¨ã€Œåˆ—å°ã€åŠŸèƒ½ï¼Œç„¶å¾Œé¸æ“‡ã€Œå¦å­˜ç‚º PDFã€');
            }

        }
    </script>

    <!-- å‹•æ…‹è¼‰å…¥ PDF ç”Ÿæˆåº« -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</body>
</html>